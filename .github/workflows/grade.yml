name: Grade CI/CD Challenge

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  grade:
    name: Grade Workflow Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Grade CI Workflow (25 points)
        id: ci
        run: |
          python -c "
          import yaml
          import sys

          try:
              with open('.github/workflows/ci.yml') as f:
                  content = f.read()
                  workflow = yaml.safe_load(content)
          except FileNotFoundError:
              print('âœ— ci.yml not found')
              with open('ci_score.txt', 'w') as f:
                  f.write('0')
              sys.exit(0)

          points = 0
          max_points = 25

          # Check triggers (5 points)
          triggers = workflow.get('on', {})
          has_push = 'push' in triggers
          has_pr = 'pull_request' in triggers
          if has_push and has_pr:
              print('âœ“ Triggers: push + pull_request')
              points += 5
          elif has_push or has_pr:
              print('~ Triggers: partial')
              points += 2
          else:
              print('âœ— Triggers: missing')

          # Check Python setup (5 points)
          if 'setup-python' in content:
              print('âœ“ Python setup')
              points += 5
          else:
              print('âœ— Python setup missing')

          # Check dependencies (5 points)
          if 'pip install' in content:
              print('âœ“ Dependencies install')
              points += 5
          else:
              print('âœ— Dependencies install missing')

          # Check linting (5 points)
          if 'flake8' in content:
              print('âœ“ Linting configured')
              points += 5
          else:
              print('âœ— Linting missing')

          # Check tests (5 points)
          if 'pytest' in content:
              print('âœ“ Tests configured')
              points += 5
          else:
              print('âœ— Tests missing')

          print(f'\nCI Score: {points}/{max_points}')
          with open('ci_score.txt', 'w') as f:
              f.write(str(points))
          "

      - name: Grade Build Workflow (25 points)
        id: build
        run: |
          python -c "
          import yaml
          import sys

          try:
              with open('.github/workflows/build.yml') as f:
                  content = f.read()
                  workflow = yaml.safe_load(content)
          except FileNotFoundError:
              print('âœ— build.yml not found')
              with open('build_score.txt', 'w') as f:
                  f.write('0')
              sys.exit(0)

          points = 0
          max_points = 25

          # Check Docker Buildx (5 points)
          if 'docker/setup-buildx-action' in content:
              print('âœ“ Docker Buildx')
              points += 5
          else:
              print('âœ— Docker Buildx missing')

          # Check login (5 points)
          if 'docker/login-action' in content:
              print('âœ“ Registry login')
              points += 5
          else:
              print('âœ— Registry login missing')

          # Check ghcr.io (5 points)
          if 'ghcr.io' in content:
              print('âœ“ GitHub Registry')
              points += 5
          else:
              print('âœ— GitHub Registry missing')

          # Check build-push-action (5 points)
          if 'docker/build-push-action' in content:
              print('âœ“ Build & Push')
              points += 5
          else:
              print('âœ— Build & Push missing')

          # Check permissions (5 points)
          if 'packages: write' in content:
              print('âœ“ Permissions')
              points += 5
          else:
              print('âœ— Permissions missing')

          print(f'\nBuild Score: {points}/{max_points}')
          with open('build_score.txt', 'w') as f:
              f.write(str(points))
          "

      - name: Grade Deploy Workflow (25 points)
        id: deploy
        run: |
          python -c "
          import yaml
          import sys

          try:
              with open('.github/workflows/deploy.yml') as f:
                  content = f.read()
                  workflow = yaml.safe_load(content)
          except FileNotFoundError:
              print('âœ— deploy.yml not found')
              with open('deploy_score.txt', 'w') as f:
                  f.write('0')
              sys.exit(0)

          points = 0
          max_points = 25

          # Check staging (5 points)
          if 'staging' in content.lower():
              print('âœ“ Staging job')
              points += 5
          else:
              print('âœ— Staging job missing')

          # Check production (5 points)
          if 'production' in content.lower():
              print('âœ“ Production job')
              points += 5
          else:
              print('âœ— Production job missing')

          # Check environments (5 points)
          if 'environment:' in content:
              print('âœ“ Environments')
              points += 5
          else:
              print('âœ— Environments missing')

          # Check conditions (5 points)
          if 'if:' in content:
              print('âœ“ Conditional deploy')
              points += 5
          else:
              print('âœ— Conditional deploy missing')

          # Check release (5 points)
          if 'release' in content:
              print('âœ“ Release trigger')
              points += 5
          else:
              print('âœ— Release trigger missing')

          print(f'\nDeploy Score: {points}/{max_points}')
          with open('deploy_score.txt', 'w') as f:
              f.write(str(points))
          "

      - name: Run Actual Tests (25 points)
        id: tests
        run: |
          pip install -r requirements.txt pytest flake8

          POINTS=0
          MAX=25

          # Run linting (10 points)
          echo "Running linter..."
          if flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics; then
            echo "âœ“ Linting passed"
            POINTS=$((POINTS + 10))
          else
            echo "âœ— Linting failed"
          fi

          # Run tests (15 points)
          echo "Running tests..."
          if pytest tests/ -v; then
            echo "âœ“ Tests passed"
            POINTS=$((POINTS + 15))
          else
            echo "âœ— Tests failed"
          fi

          echo "Tests Score: $POINTS/$MAX"
          echo $POINTS > tests_score.txt

      - name: Calculate Total Score
        id: total
        run: |
          CI=$(cat ci_score.txt)
          BUILD=$(cat build_score.txt)
          DEPLOY=$(cat deploy_score.txt)
          TESTS=$(cat tests_score.txt)

          TOTAL=$((CI + BUILD + DEPLOY + TESTS))
          MAX=100

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           CI/CD PIPELINE CHALLENGE         "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ“‹ CI Workflow:      $CI/25 points"
          echo "  ğŸ³ Build Workflow:   $BUILD/25 points"
          echo "  ğŸš€ Deploy Workflow:  $DEPLOY/25 points"
          echo "  âœ… Tests Pass:       $TESTS/25 points"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  ğŸ“Š TOTAL SCORE: $TOTAL/$MAX points"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

          if [ $TOTAL -eq $MAX ]; then
            echo "  ğŸ‰ PERFECT SCORE! You mastered CI/CD pipelines!"
          elif [ $TOTAL -ge 75 ]; then
            echo "  âœ¨ Great job! Your pipelines are solid!"
          elif [ $TOTAL -ge 50 ]; then
            echo "  ğŸ“ˆ Good progress! Keep improving!"
          else
            echo "  ğŸ’ª Keep practicing! Check the README for hints."
          fi
          echo ""

          # Fail if not passing
          if [ $TOTAL -lt 60 ]; then
            exit 1
          fi
